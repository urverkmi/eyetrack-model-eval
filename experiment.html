<!DOCTYPE html>
<html>
<head>
    <title>Gaze Experiment</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #image-container { width: 100vw; height: 100vh; display: flex;
                           justify-content: center; align-items: center; }
        #stimulus { max-width: 90vw; max-height: 90vh; }
        #download { position: fixed; top: 10px; right: 10px; }
    </style>
</head>

<body>
<button id="download">Download Data</button>
<div id="image-container">
    <img id="stimulus">
</div>

<script>
let images = [
    "images/i1.jpg",
    "images/i2.jpg",
    "images/i3.jpg"
];

let gazeLog = [];
let trialIndex = 0;
let currentImage = null;

function startWebgazer() {
    webgazer.setGazeListener((data, ts) => {
        if (data == null) return;
        gazeLog.push({
            t: ts,
            x: data.x,
            y: data.y,
            trial: trialIndex,
            img: currentImage
        });
    }).begin();
}

function showNextImage() {
    if (trialIndex >= images.length) {
        alert("Experiment finished!");
        return;
    }
    currentImage = images[trialIndex];
    document.getElementById("stimulus").src = currentImage;
    trialIndex++;
    setTimeout(showNextImage, 3000);  // 3 seconds per image
}

document.getElementById("download").onclick = () => {
    let blob = new Blob([JSON.stringify(gazeLog)], {type: "application/json"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "gaze_data.json";
    a.click();
};

startWebgazer();
showNextImage();
</script>
</body>
</html>
